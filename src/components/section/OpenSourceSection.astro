---
import { getCollection } from "astro:content";
import PRDropdown from "~/components/opensource/PRDropdown.svelte";
import type { GroupedPRs } from "~/types/github-pr.ts";

const githubPRs = await getCollection("github");

function groupPRsByRepository(prs: typeof githubPRs): GroupedPRs {
	return prs.reduce((acc: GroupedPRs, pr) => {
		const repoName = pr.data.repository.name;

		if (!acc[repoName]) {
			acc[repoName] = {
				repository: pr.data.repository,
				prs: [],
				mergedCount: 0,
			};
		}

		acc[repoName].prs.push(pr.data);
		if (pr.data.state === "merged") {
			acc[repoName].mergedCount++;
		}

		return acc;
	}, {});
}

const groupedPRs = groupPRsByRepository(githubPRs);
const sortedRepositories = Object.entries(groupedPRs).sort(
	([, a], [, b]) => b.mergedCount - a.mergedCount,
);
---

<section class="pt-8 md:pt-12">
	<h2
		id="open-source-contributions-heading"
		class="work-experience-card text-2xl md:text-3xl font-bold font-display text-pink-950 tracking-wide pb-4 pt-2"
	>
		Open Source Contributions
	</h2>
	<p class="text-xs md:text-base font-body text-pink-950/70 pt-2 pb-4">
		Here are some of my merged pull requests across various open source projects.
	</p>

	<div class="relative flex flex-col gap-2">
		{sortedRepositories.map(([, data]) => (
			<div class="work-experience-card">
				<PRDropdown
					repository={data.repository}
					prs={data.prs}
					client:idle
				/>
			</div>
		))}
	</div>
	{sortedRepositories.length === 0 && (
		<div class="text-center py-8 border border-pink-200 rounded-lg">
			<p class="text-sm font-body text-pink-950/60">
				No open source contributions found or unable to fetch data.
			</p>
		</div>
	)}
</section>
